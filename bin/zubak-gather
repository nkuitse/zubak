#!/bin/zsh

main() {
    typeset opt full=false incr=false remote=false base cmd=find tmp
    while getopts :firb:c: opt; do
        case $opt in
            (f) full=true ;;
            (i) incr=true ;;
            (r) remote=true ;;
            (b) base=$OPTARG ;;
            (c) cmd=$OPTARG ;;
        esac
    done
    shift $(( OPTIND - 1 ))
    $full || $incr || exit 1
    $full && $incr && exit 1
    if $remote; then
        # ssh $host zubak-gather -r -f [-c COMMAND] ARG...
        # ssh $host zubak-gather -r -i [-c COMMAND] ARG... [< BASE.eum]
        [[ -z $base ]] || exit 2
        if $incr; then
            tmp=$(mktemp -d /tmp/zubak-gather.$$.XXXXXX)
            [[ -d $tmp ]] || exit 2
            base=$tmp/base
            cat > $base.eum || exit 2
            $cmd $@ | eubdiff $base | eubar -s
        else
            $cmd $@ | eubar
        fi
    elif [[ -n $base ]]; then
        # zubak-gather -i -b BASE [-i] [-c COMMAND] ARG...
        $incr || exit 2
        $cmd $@ | eubdiff $base | eubar -s
    elif $incr; then
        # zubak-gather -i [-c COMMAND] ARG... => ERROR
        exit 1
    else
        # zubak-gather -f [-c COMMAND] ARG...
        $cmd $@ | eubar
    fi
    [[ -z $tmp ]] || rm -Rf $tmp
}

main "$@"
