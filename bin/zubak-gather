#!/bin/zsh

main() {
    typeset opt clientmode=false bref cmd=find tmp
    while getopts :ci:e: opt; do
        case $opt in
            (c) clientmode=true ;;
            (i) bref=$OPTARG ;;
            (e) cmd=$OPTARG ;;
        esac
    done
    shift $(( OPTIND - 1 ))
    if $clientmode; then
        # This script is being run on the client machine; output will go to the server
        [[ -z $bref ]] || exit 2
        if [[ -n $bref ]]; then
            # ssh $thishost zubak-gather -c -i BASE [-e COMMAND] ARG... [< BASE.eum]
            tmp=$(mktemp -d /tmp/zubak-gather.$$.XXXXXX)
            cat > $tmp/$bref.eum || exit 2
            $cmd $@ | eubdiff $tmp/$bref | eubar -s
            if [[ -d /var/local/backup/local/ ]]; then
                mv $tmp /var/local/backup/local/
            else
                rm -Rf $tmp
            fi
        else
            # ssh $thishost zubak-gather -c -f [-e COMMAND] ARG...
            $cmd $@ | eubar
        fi
    elif [[ -n $bref ]]; then
        # zubak-gather -i BASE [-e COMMAND] ARG...
        $cmd $@ | eubdiff $bref | eubar -s
    else
        # zubak-gather -f [-e COMMAND] ARG...
        $cmd $@ | eubar
    fi
}

main "$@"
