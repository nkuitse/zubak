#!/bin/zsh

typeset b=$1 now=$2; shift 2
typeset hash offset size file

print -l "backup $b" "begin $now" >> $b.backup

bakz-gather $b $@ 2>> metadata |
bakz-split $b |
while read hash offset size file; do
    (( n++ < MAXN )) || wait
    ( bakz-compress < $file |
      bakz-save $b
    ) &
    print "@$offset *$size #$hash $file"
done >> $b.backup
wait

